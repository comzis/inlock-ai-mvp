# Security Improvements - December 24, 2025

## Summary

This document summarizes the security and infrastructure improvements made on December 24, 2025, addressing the security review findings.

---

## Changes Made

### 1. Fixed Hardcoded Credentials ✅

**File:** `compose/services/tooling.yml`

**Issue:** ClickHouse password was hardcoded in multiple places (`dbbKUiRTs8knEbH5`)

**Fix:**
- Replaced hardcoded password with environment variable: `${POSTHOG_CLICKHOUSE_PASSWORD:?Required}`
- Updated all PostHog services (web, worker, plugins) and ClickHouse container
- Added `POSTHOG_CLICKHOUSE_PASSWORD` to `env.example`

**Impact:** Credentials now managed via environment variables, not in source code

---

### 2. Fixed Path Issues in stack.yml ✅

**File:** `compose/services/stack.yml`

**Issue:** Incorrect volume mount paths (e.g., `/e../../config/traefik/traefik.yml`)

**Fixes:**
- Traefik config path: Fixed to `/etc/traefik/traefik.yml`
- Traefik dynamic path: Fixed to `/etc/traefik/dynamic`
- Traefik ACME path: Fixed to `/etc/traefik/acme`
- Prometheus config path: Fixed to `/etc/prometheus/prometheus.yml`
- Prometheus rules path: Fixed to `/etc/prometheus/rules`
- Alertmanager config path: Fixed to `/etc/alertmanager/alertmanager.yml`
- Logging include path: Fixed to `../config/monitoring/logging.yml`

**Impact:** Services can now correctly mount configuration files

---

### 3. Pinned Image Versions ✅

**File:** `compose/services/stack.yml`

**Issue:** Several services using `:latest` tags, making updates unpredictable

**Fixes:**
- Grafana: `grafana/grafana:latest` → `grafana/grafana:11.1.0`
- Alertmanager: `prom/alertmanager:latest` → `prom/alertmanager:v0.27.0`
- cAdvisor: `gcr.io/cadvisor/cadvisor:latest` → `gcr.io/cadvisor/cadvisor:v0.49.1`
- Node Exporter: `prom/node-exporter:latest` → `prom/node-exporter:v1.8.2`
- Blackbox Exporter: `prom/blackbox-exporter:latest` → `prom/blackbox-exporter:v0.27.0`

**Remaining `:latest` tags (intentional or low priority):**
- PostHog services (analytics - may need frequent updates)
- Homarr, Coolify, Socat (tooling services)
- `inlock-ai:latest` (application image - built locally)

**Impact:** More predictable deployments, easier rollback if needed

---

### 4. Verified Traefik/Auth Configuration ✅

**File:** `traefik/dynamic/routers.yml`

**Verification:**
- ✅ All admin services use `admin-forward-auth` middleware
- ✅ All admin services use `allowed-admins` IP allowlist
- ✅ All admin services use `secure-headers` middleware
- ✅ Rate limiting enabled on most admin services

**Services Verified:**
- Portainer (`portainer.inlock.ai`)
- Grafana (`grafana.inlock.ai`)
- n8n (`n8n.inlock.ai`)
- Coolify (`deploy.inlock.ai`)
- Homarr (`dashboard.inlock.ai`)
- Traefik Dashboard (`traefik.inlock.ai`)

**Removed Redundancy:**
- Removed duplicate `admin-ip-allowlist` middleware (redundant with `allowed-admins`)

**Impact:** Confirmed all admin services are properly protected

---

### 5. Consolidated Security Documentation ✅

**New File:** `archive/docs/security/SECURITY-POSTURE-2025-12-24.md`

**Purpose:** Single source of truth for current security status

**Contents:**
- Current security score (8.5/10)
- Detailed breakdown by component
- Security strengths and areas for improvement
- Recent improvements summary
- Verification commands
- Next steps

**Impact:** Clear, up-to-date security status documentation

---

## Files Modified

1. `compose/services/tooling.yml` - Removed hardcoded credentials
2. `compose/services/stack.yml` - Fixed paths, pinned images
3. `env.example` - Added `POSTHOG_CLICKHOUSE_PASSWORD`
4. `traefik/dynamic/routers.yml` - Removed redundant middleware
5. `archive/docs/security/SECURITY-POSTURE-2025-12-24.md` - New consolidated security doc
6. `docs/security/CHANGES-2025-12-24.md` - This document

---

## Testing Required

### Before Deployment

1. **Verify Environment Variables:**
   ```bash
   # Ensure POSTHOG_CLICKHOUSE_PASSWORD is set in .env.tooling
   grep POSTHOG_CLICKHOUSE_PASSWORD /home/comzis/deployments/.env.tooling
   ```

2. **Validate Compose Files:**
   ```bash
   docker compose -f compose/services/stack.yml config
   docker compose -f compose/services/tooling.yml config
   ```

3. **Check Image Availability:**
   ```bash
   docker pull grafana/grafana:11.1.0
   docker pull prom/alertmanager:v0.27.0
   docker pull gcr.io/cadvisor/cadvisor:v0.49.1
   docker pull prom/node-exporter:v1.8.2
   docker pull prom/blackbox-exporter:v0.27.0
   ```

### After Deployment

1. **Verify Services Start:**
   ```bash
   docker compose -f compose/services/stack.yml ps
   ```

2. **Check Logs for Errors:**
   ```bash
   docker compose -f compose/services/stack.yml logs --tail 50
   ```

3. **Test Admin Access:**
   - Verify OAuth2 forward-auth works
   - Test IP allowlist restrictions
   - Confirm rate limiting is active

---

## Rollback Plan

If issues occur:

1. **Revert Image Versions:**
   ```bash
   # Restore :latest tags in stack.yml
   git checkout HEAD -- compose/services/stack.yml
   ```

2. **Restore Credentials (if needed):**
   ```bash
   # Temporarily restore hardcoded password if env var not set
   # (NOT RECOMMENDED - fix env var instead)
   ```

3. **Revert Path Changes:**
   ```bash
   git checkout HEAD -- compose/services/stack.yml
   ```

---

## Next Steps

1. **Immediate:**
   - Set `POSTHOG_CLICKHOUSE_PASSWORD` in `.env.tooling`
   - Test compose file validation
   - Pull new image versions

2. **Short Term:**
   - Verify OAuth2-Proxy functionality
   - Test all admin service access
   - Monitor for any issues

3. **Long Term:**
   - Pin remaining `:latest` tags
   - Move Strapi behind Traefik
   - Regular security reviews

---

**Date:** December 24, 2025  
**Author:** Infrastructure Team  
**Status:** Ready for Review




