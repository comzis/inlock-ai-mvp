# Vulnerability Scanning Guide

**Date:** 2025-12-28  
**Status:** Active

---

## Overview

This infrastructure uses Trivy for automated vulnerability scanning of Docker containers, images, and the host filesystem. Scanning is integrated into the CI/CD pipeline and can be run manually for ad-hoc security audits.

---

## Tools Used

- **Trivy**: Comprehensive vulnerability scanner by Aqua Security
- **GitHub Actions**: Automated scanning in CI/CD pipeline
- **Reports**: JSON, HTML, and table format outputs

---

## Installation

### Install Trivy

Run the installation script:

```bash
sudo ./scripts/security/install-trivy.sh
```

This will:
- Download the latest Trivy binary
- Install to `/usr/local/bin/trivy`
- Initialize the vulnerability database
- Verify installation

### Verify Installation

```bash
trivy --version
```

---

## Usage

### Scan Running Containers

Scan all currently running Docker containers:

```bash
./scripts/security/scan-containers.sh
```

**Options:**
- `--format <json|html|table|all>` - Output format (default: all)
- `--output-dir <dir>` - Output directory (default: `archive/docs/reports/security/vulnerabilities`)
- `--fail-on-critical` - Exit with error if critical vulnerabilities found
- `--severity <level>` - Minimum severity (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN)

**Example:**
```bash
# Scan with JSON output only, fail on critical
./scripts/security/scan-containers.sh --format json --fail-on-critical
```

### Scan Docker Images

Scan images defined in Docker Compose files:

```bash
./scripts/security/scan-images.sh
```

**Options:**
- `--compose-file <file>` - Compose file to scan (default: `compose/services/stack.yml`)
- `--format <json|html|table|all>` - Output format
- `--output-dir <dir>` - Output directory
- `--fail-on-critical` - Exit with error if critical vulnerabilities found
- `--severity <level>` - Minimum severity
- `--pull` - Pull images before scanning

**Example:**
```bash
# Scan specific compose file, pull images first
./scripts/security/scan-images.sh \
  --compose-file compose/services/stack.yml \
  --pull \
  --fail-on-critical
```

### Scan Host Filesystem

Scan the host system for package vulnerabilities:

```bash
sudo ./scripts/security/scan-filesystem.sh
```

**Options:**
- `--format <json|html|table|all>` - Output format
- `--output-dir <dir>` - Output directory
- `--fail-on-critical` - Exit with error if critical vulnerabilities found
- `--severity <level>` - Minimum severity

**Note:** Requires root access to scan system packages.

---

## CI/CD Integration

### GitHub Actions Workflow

The workflow (`.github/workflows/vulnerability-scanning.yml`) automatically:

1. **Triggers:**
   - On pull requests to `main`
   - On pushes to `main`
   - Weekly schedule (Monday 2 AM UTC)
   - Manual workflow dispatch

2. **Actions:**
   - Extracts images from compose files
   - Scans all images for vulnerabilities
   - Generates reports
   - Uploads reports as artifacts
   - Comments PR if vulnerabilities found
   - Fails PR if critical vulnerabilities detected

### Viewing Results

1. **In GitHub Actions:**
   - Go to Actions tab
   - Select "Vulnerability Scanning" workflow
   - View run details
   - Download reports from artifacts

2. **In Pull Requests:**
   - Check PR comments for summary
   - Review workflow run status
   - Download reports from workflow artifacts

---

## Interpreting Scan Results

### Severity Levels

- **CRITICAL**: Immediate action required, remote code execution possible
- **HIGH**: Should be fixed soon, significant security impact
- **MEDIUM**: Moderate risk, fix when possible
- **LOW**: Low risk, informational
- **UNKNOWN**: Severity not determined

### Report Formats

#### JSON Format
Structured data for programmatic processing:
```json
{
  "Results": [
    {
      "Vulnerabilities": [
        {
          "VulnerabilityID": "CVE-2024-XXXX",
          "Severity": "CRITICAL",
          "Title": "Vulnerability Title",
          "Description": "Detailed description",
          "FixedVersion": "1.2.3"
        }
      ]
    }
  ]
}
```

#### HTML Format
Human-readable report with:
- Vulnerability details
- CVE links
- Fix versions
- Impact assessment

#### Table Format
Simple text output for quick review in terminal.

---

## Remediation Procedures

### For Container Images

1. **Update Base Image:**
   ```bash
   # Find the vulnerable package
   trivy image <image-name> --format json | jq '.Results[].Vulnerabilities[] | select(.Severity == "CRITICAL")'
   
   # Update to fixed version in Dockerfile
   FROM <base-image>:<fixed-version>
   ```

2. **Rebuild Image:**
   ```bash
   docker build -t <image-name>:<new-tag> .
   docker push <image-name>:<new-tag>
   ```

3. **Update Compose File:**
   ```yaml
   services:
     service-name:
       image: <image-name>:<new-tag>
   ```

4. **Rescan:**
   ```bash
   ./scripts/security/scan-images.sh --compose-file compose/services/stack.yml
   ```

### For Host System

1. **Update System Packages:**
   ```bash
   sudo apt update
   sudo apt upgrade
   ```

2. **Check Automatic Updates:**
   ```bash
   sudo unattended-upgrades --dry-run
   ```

3. **Rescan:**
   ```bash
   sudo ./scripts/security/scan-filesystem.sh
   ```

### For Running Containers

1. **Stop Vulnerable Container:**
   ```bash
   docker stop <container-name>
   ```

2. **Update Image:**
   - Follow container image remediation steps
   - Pull updated image

3. **Restart Container:**
   ```bash
   docker compose up -d <service-name>
   ```

4. **Rescan:**
   ```bash
   ./scripts/security/scan-containers.sh
   ```

---

## Best Practices

### Regular Scanning

1. **Automated:**
   - CI/CD pipeline scans on every PR
   - Weekly scheduled scans
   - Pre-deployment scans

2. **Manual:**
   - Before major deployments
   - After security advisories
   - Quarterly comprehensive audits

### Vulnerability Management

1. **Prioritize:**
   - Fix CRITICAL vulnerabilities immediately
   - Address HIGH within 30 days
   - Plan MEDIUM fixes in next release cycle

2. **Document:**
   - Track vulnerability fixes in changelog
   - Document remediation steps
   - Update security policies

3. **Verify:**
   - Always rescan after fixes
   - Test fixes in staging
   - Monitor for regressions

### Integration with Deployment

1. **Pre-Deployment:**
   ```bash
   # Scan images before deployment
   ./scripts/security/scan-images.sh --fail-on-critical --pull
   ```

2. **Post-Deployment:**
   ```bash
   # Scan running containers after deployment
   ./scripts/security/scan-containers.sh --fail-on-critical
   ```

---

## Troubleshooting

### Trivy Database Issues

**Problem:** Trivy fails to download vulnerability database

**Solution:**
```bash
trivy image --download-db-only
```

### Scan Timeout

**Problem:** Scans take too long or timeout

**Solution:**
- Scan images individually
- Use `--severity HIGH,CRITICAL` to filter results
- Increase timeout in CI/CD workflow

### False Positives

**Problem:** Vulnerabilities reported that don't affect your use case

**Solution:**
- Review vulnerability details
- Check if vulnerable code path is used
- Consider using `--ignorefile` for known false positives
- Document rationale for ignoring specific CVEs

### CI/CD Failures

**Problem:** Pipeline fails due to vulnerabilities

**Solution:**
1. Review vulnerability reports
2. Fix critical issues
3. For non-critical issues, update workflow thresholds
4. Document exceptions

---

## Report Locations

All scan reports are saved to:
```
archive/docs/reports/security/vulnerabilities/
```

**Naming Convention:**
- Containers: `container-scan-<timestamp>-<container-name>.<format>`
- Images: `image-scan-<timestamp>-<image-name>.<format>`
- Filesystem: `filesystem-scan-<timestamp>-<hostname>.<format>`

**Retention:**
- Local reports: Manual cleanup recommended
- CI/CD artifacts: 30 days (automated)

---

## Related Documentation

- [Security Review Report](../security/SECURITY-REVIEW-2025-12-11.md)
- [Container Hardening](../security/CONTAINER-HARDENING.md)
- [Project Structure Assessment](../../PROJECT-STRUCTURE-ASSESSMENT.md)

---

## Additional Resources

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [CVE Database](https://cve.mitre.org/)
- [Docker Security Best Practices](https://docs.docker.com/engine/security/)

---

**Last Updated:** 2025-12-28







