# Mailcow Deployment Guide

**Date:** December 25, 2025  
**Purpose:** Mailcow email server deployment and management

---

## Overview

Mailcow has replaced Mailu as the production mail server stack. Mailcow provides a complete, Docker-based email solution with proven Dovecot compatibility and comprehensive web UI.

**Location:** `/home/comzis/mailcow`

---

## Quick Start

### Start Mailcow
```bash
cd /home/comzis/mailcow
docker compose up -d
```

### Stop Mailcow
```bash
cd /home/comzis/mailcow
docker compose down
```

### View Logs
```bash
cd /home/comzis/mailcow
docker compose logs -f
```

---

## Initial Setup

### 1. Configuration

Mailcow configuration is in `/home/comzis/mailcow/mailcow.conf`:

- **Hostname:** `mail.inlock.ai`
- **Let's Encrypt:** Disabled (using Traefik for TLS)
- **SOGo:** Enabled (webmail/calendar)

### 2. First Login

1. Access: `https://mail.inlock.ai`
2. Default credentials:
   - **Username:** `admin`
   - **Password:** `moohoo`
3. **IMPORTANT:** Change password on first login

### 3. Create Mailboxes

Via Mailcow UI:
1. Login to `https://mail.inlock.ai`
2. Navigate to "Configuration" → "Mail Setup" → "Mailboxes"
3. Click "Add mailbox"
4. Enter email address (e.g., `milorad.stevanovic@inlock.ai`)
5. Set password and quota
6. Save

---

## Validation

### IMAP Authentication Test

```bash
cd /home/comzis/mailcow
docker compose exec dovecot-mailcow doveadm auth test milorad.stevanovic@inlock.ai 'Test123!@#'
```

**Expected output:**
```
passdb: milorad.stevanovic@inlock.ai auth succeeded
extra fields:
  user=milorad.stevanovic@inlock.ai
```

### Port Connectivity

```bash
# SMTP Submission (STARTTLS)
nc -zv mail.inlock.ai 587

# IMAP (SSL/TLS)
nc -zv mail.inlock.ai 993
```

### Webmail Access

1. Open incognito browser
2. Navigate to `https://mail.inlock.ai`
3. Login with mailbox credentials
4. Should land in SOGo webmail (no redirect loop)

---

## Networking

### Current Setup

**Option:** Mailcow handles TLS directly (simplest)

- Mailcow nginx serves HTTP/HTTPS on ports 80/443
- Postfix handles SMTP on ports 25/465/587
- Dovecot handles IMAP on ports 143/993

### Traefik Integration (Optional)

If using Traefik in front of Mailcow:

1. **TCP Routers** for mail ports:
   - Port 25 → Mailcow postfix
   - Port 465 → Mailcow postfix
   - Port 587 → Mailcow postfix
   - Port 993 → Mailcow dovecot
   - Port 995 → Mailcow dovecot

2. **HTTP Router** for web UI:
   - `mail.inlock.ai` → Mailcow nginx (port 80)

3. **PROXY Protocol:** Disable if uncertain (Mailcow default doesn't require it)

---

## DNS Configuration

### Required Records

1. **A/AAAA Record:**
   ```
   mail.inlock.ai → <server-ip>
   ```

2. **MX Record:**
   ```
   inlock.ai → mail.inlock.ai (priority 10)
   ```

3. **SPF Record:**
   ```
   TXT @ "v=spf1 mx a:mail.inlock.ai ~all"
   ```

4. **DKIM Record:**
   - Generated by Mailcow
   - View in Mailcow UI: "Configuration" → "Configuration & Details" → "DKIM keys"
   - Add as TXT record: `mail._domainkey.inlock.ai`

5. **DMARC Record:**
   ```
   TXT _dmarc.inlock.ai "v=DMARC1; p=quarantine; rua=mailto:admin@inlock.ai"
   ```

---

## Service Management

### Check Status
```bash
cd /home/comzis/mailcow
docker compose ps
```

### Restart Services
```bash
cd /home/comzis/mailcow
docker compose restart
```

### Update Mailcow
```bash
cd /home/comzis/mailcow
git pull
docker compose pull
docker compose up -d
```

### Backup
```bash
cd /home/comzis/mailcow
./helper-scripts/backup_and_restore.sh backup all
```

---

## Troubleshooting

### IMAP Auth Fails

1. Check user exists:
   ```bash
   docker compose exec dovecot-mailcow doveadm user milorad.stevanovic@inlock.ai
   ```

2. Check logs:
   ```bash
   docker compose logs dovecot-mailcow | tail -50
   ```

3. Reset password via Mailcow UI

### Webmail Redirect Loop

1. Check Mailcow nginx logs:
   ```bash
   docker compose logs nginx-mailcow | tail -50
   ```

2. Verify DNS resolution:
   ```bash
   dig mail.inlock.ai
   ```

3. Check Traefik routing (if used)

### Port Conflicts

If ports are already in use:
1. Check what's using them:
   ```bash
   sudo netstat -tulpn | grep -E '587|993|25|465'
   ```

2. Stop conflicting services (e.g., legacy mail stacks)

---

## Security Notes

1. **Change default admin password** immediately
2. **Enable 2FA** for admin account
3. **Regular backups** (see Backup section)
4. **Keep Mailcow updated** (see Update section)
5. **Monitor logs** for suspicious activity

---

## References

- **Mailcow Documentation:** https://mailcow.github.io/mailcow-dockerized-docs/
- **Mailcow GitHub:** https://github.com/mailcow/mailcow-dockerized
- **SOGo Documentation:** https://sogo.nu/

---

**Last Updated:** December 25, 2025

