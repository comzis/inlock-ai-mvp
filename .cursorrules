# Inlock AI Infrastructure - Cursor AI Rules

## Project Overview
This is the Inlock AI infrastructure repository containing Docker Compose configurations, Traefik reverse proxy setup, deployment scripts, and comprehensive documentation. Mailcow is the production mail stack and lives outside the repo at `/home/comzis/mailcow`.

## Directory Structure - DO NOT DEVIATE

```
inlock-ai-mvp/
├── ansible/              # Infrastructure automation (Provisioning)
├── compose/              # ALL Docker Compose service definitions
│   ├── services/         # Service compose files
│   │   └── stack.yml     # Main aggregator (include-based stack)
│   ├── config/           # Shared config fragments for compose
│   ├── scripts/          # Build/deploy scripts for compose services
│   ├── docker/           # Custom Docker images (Dockerfiles)
│   ├── n8n/              # n8n workflow definitions
│   ├── grafana/          # Grafana dashboards and provisioning
│   ├── cockpit-proxy/    # Cockpit proxy configuration
│   ├── stack-fallback.yml.example  # Example fallback stack
│   └── stack.yml.new     # Sample stack file
├── config/               # Service configuration files (templates only, no secrets)
│   ├── alertmanager/     # Alertmanager configuration
│   ├── grafana/          # Grafana dashboards and provisioning
│   ├── monitoring/       # Monitoring service configs
│   ├── nginx/            # Nginx configuration templates
│   ├── prometheus/       # Prometheus config and alert rules
│   └── traefik/          # Traefik base/static config and cert templates
├── traefik/              # Runtime Traefik data
│   ├── acme/             # ACME certificate storage
│   └── dynamic/          # Dynamic routing configs (routers, middlewares)
├── docs/                 # ALL documentation
│   ├── architecture/     # High-level design & diagrams
│   ├── audit/            # Audit logs
│   ├── deployment/       # Deployment guides
│   ├── guides/           # Day-2 operations guides
│   ├── reference/        # API refs, cheat sheets
│   ├── reports/          # Status reports
│   ├── security/         # Security documentation
│   ├── services/         # Service-specific documentation
│   ├── tooling-deployment/  # Tooling deployment guides
│   └── index.md          # Documentation entry point
├── e2e/                  # Playwright end-to-end tests
├── scripts/              # ALL automation scripts
├── secrets/              # Secret templates (NOT actual secrets)
├── env.example           # Environment variable template
├── README.md             # Main repository documentation
├── QUICK-START.md        # Quick start guide
└── .agent/workflows/     # Workflow documentation (if present)
```

## CRITICAL RULES - Never Break These

### ❌ What to Avoid (NEVER DO)

1. **DO NOT create competing directory structures**
   - No `infrastructure/` directory
   - No separate config directories parallel to existing ones
   - Use existing `compose/`, `traefik/`, `docs/` structure

2. **DO NOT duplicate configuration files**
   - No `email.yml` AND `mailu.yml` for same service
   - No `main-stack.yml` AND `stack.yml`
   - One authoritative file per service

3. **DO NOT ignore Git workflow**
   - Always check for unmerged branches first
   - Pull latest before making changes
   - Use feature branches for new work

4. **DO NOT deviate from established patterns**
   - Docker Compose files go in `compose/`
   - Traefik configs go in `traefik/dynamic/`
   - Documentation goes in `docs/` (organized by topic)
   - Scripts go in `scripts/`
   
5. **DO NOT rely on ephemeral fixes**
   - No `docker exec` to patch files in running containers
   - No manual changes inside containers that are lost on restart
   - No relying on container local filesystem for config
   - ALWAYS use custom Docker images or bind mounts for persistence

### ✅ Best Practices - Always Follow

1. **File Organization**
   - Docker Compose: `compose/services/<service>.yml` (or fragments in `compose/config/`)
   - Main stack: `compose/services/stack.yml` (include-based aggregator)
   - Traefik routers: `traefik/dynamic/routers.yml`
   - Deployment Guides: `docs/deployment/` and `docs/tooling-deployment/`
   - Day-2 Operations: `docs/guides/`
   - Architecture/Design: `docs/architecture/`
   - References/Cheat Sheets: `docs/reference/`
   - Reports/Status: `docs/reports/`
   - Security Docs: `docs/security/`
   - Service Docs: `docs/services/`
   - Documentation Index: `docs/index.md`

2. **Naming Conventions**
   - Services: `<service-name>.yml` (e.g., `tooling.yml`, `n8n.yml`)
   - Scripts: `<action>-<target>.sh` (e.g., `test-service-quick.sh`)
   - Docs: Descriptive names in CAPS with hyphens
   
3. **Docker Persistence**
   - **Custom Images:** For code changes / patches (e.g. `mailu-admin-patched`)
   - **Bind Mounts:** For configuration files (e.g. `/overrides/config.inc.php`)
   - **Verify:** Always test `docker compose restart` after changes

4. **Git Workflow**
   ```bash
   # Before making changes
   git pull origin main
   
   # Create feature branch
   git checkout -b feature/<description>
   
   # Make changes, test, commit
   git commit -m "type: descriptive message"
   
   # Push and create PR
   git push origin feature/<description>
   ```

5. **Documentation Updates**
   - Update `docs/index.md` for major changes (entry point)
   - Deployment guides → `docs/deployment/` and `docs/tooling-deployment/`
   - Day-2/Operations guides → `docs/guides/`
   - Architecture/Design docs → `docs/architecture/`
   - References/Cheat sheets → `docs/reference/`
   - Reports/Status → `docs/reports/`
   - Security docs → `docs/security/`
   - Service-specific docs → `docs/services/`
   - Keep root directory clean (only README, QUICK-START, etc.)

## Environment & Secrets

**Locations:**
- Templates: `/env.example` in repo
- Actual envs: `/home/comzis/deployments/.env.*` (NOT in repo)
- Docker secrets: `/home/comzis/apps/secrets-real/` (NOT in repo)

**Never commit:**
- `.env` files with real values
- Secret files
- Passwords or tokens
- SSH private keys (`*.key`, `*_key`, `id_*`)
- SSH public keys (`*.pub`, `*_key.pub`) - unless intentionally public

**Mailcow authentication (production):**
- Mailcow lives at `/home/comzis/mailcow`; set `MAILCOW_PASS_SCHEME=BLF-CRYPT` in `mailcow.conf`.
- Validate logins with `docker compose exec dovecot-mailcow doveadm auth test <user> '<pass>'`.

## Deployment Commands (CI/CD)

**Primary Method:**
- **Automated**: Push a tag (e.g. `v1.0.0`) to trigger GitHub Actions.
- **Manual (Emergency)**: See `docs/deployment/DEPLOYMENT.md`.

**Local Testing / Development:**
```bash
docker compose -f docker-compose.local.yml up -d
```

**With environment file:**
```bash
docker compose -f compose/<service>.yml \
  --env-file /home/comzis/deployments/.env.<service> up -d
```

## Security Guidelines

1. **Network Isolation**
   - Admin services: Only on `mgmt` network
   - Public services: On `edge` network via Traefik
   - Internal services: On `internal` network only

2. **Authentication**
   - All admin interfaces behind Auth0 + OAuth2-Proxy
   - IP allowlists as secondary layer
   - No direct service exposure

3. **Hardening**
   - Drop ALL capabilities
   - Use `no-new-privileges`
   - Read-only filesystems where possible
   - Load secrets via Docker secrets

4. **System Security**
   - Full security rules live in `.cursorrules-security`
   - NEVER open firewall ports, change sudo config, or modify SSH without explicit user approval
   - Server maintains 10/10 security score - preserve it

## Code Style

**Docker Compose:**
- Use secrets for sensitive data
- Always define networks explicitly
- Include health checks
- Set resource limits
- Use specific image tags (not `latest` in production)

**Shell Scripts:**
- Include shebang: `#!/bin/bash`
- Set error handling: `set -euo pipefail`
- Add help text
- Make executable: `chmod +x`

## Making Changes

### Adding a New Service

1. Create `compose/services/<service>.yml` (or reusable fragment in `compose/config/`)
2. Add to `compose/services/stack.yml` includes (if part of main stack)
3. Validate: `docker compose -f compose/services/stack.yml config`
4. Create deployment guide in `docs/tooling-deployment/` or `docs/deployment/`
5. Add Traefik routers to `traefik/dynamic/routers.yml`
6. Update `env.example` with new variables
7. Test deployment
8. Update README.md

### Modifying Existing Service

1. Check current state: `docker compose ps <service>`
2. Edit `compose/services/<service>.yml` (or fragment in `compose/config/`)
3. Validate: `docker compose -f compose/services/stack.yml config` (or individual file)
4. Deploy: `docker compose -f compose/services/stack.yml up -d` (or individual service)
5. Verify: Check logs and health
6. Document changes

### Organizing Files

- **Status reports** → `docs/reports/<topic>/`
- **Audit logs** → `docs/audit/`
- **Deployment guides** → `docs/deployment/` and `docs/tooling-deployment/`
- **Day-2 Operations** → `docs/guides/`
- **Architecture/Design** → `docs/architecture/`
- **References/Cheat sheets** → `docs/reference/`
- **Security docs** → `docs/security/`
- **Service docs** → `docs/services/`
- **Scripts** → `scripts/`
- **Service configs** → `config/<service>/` (templates only)
- **Traefik static config** → `config/traefik/`
- **Traefik dynamic config** → `traefik/dynamic/`

## Quick Reference

**Repository:** https://github.com/comzis/inlock-ai-mvp
**Server path:** /home/comzis/inlock (symlink to /home/comzis/projects/inlock-ai-mvp)
**Mailcow path:** /home/comzis/mailcow
**Deployments:** /home/comzis/deployments/
**Secrets:** /home/comzis/apps/secrets-real/

## When in Doubt

1. Check existing patterns in the repo
2. Look at similar services
3. Review this file
4. Ask before creating new directory structures
5. Keep it simple - use what exists

## Compose/Stack Architecture

**Main Stack:** `compose/services/stack.yml` is the include-based aggregator that:
- Defines shared networks: `edge`, `mgmt`, `internal`, `socket-proxy`
- Manages shared secrets and volumes
- Includes individual service compose files via `include:` directive

**Adding a Service:**
1. Create compose file: `compose/services/<service>.yml` (or reusable fragment in `compose/config/`)
2. Add to `include:` list in `compose/services/stack.yml`
3. Validate before deploy: `docker compose -f compose/services/stack.yml config`
4. Deploy: `docker compose -f compose/services/stack.yml up -d`

**Service Configs:**
- Individual service compose files go in `compose/services/`
- Reusable config fragments (shared volumes, networks) go in `compose/config/`
- Custom Docker images (Dockerfiles) go in `compose/docker/`

## Config vs Traefik Directories

**`config/traefik/`:**
- Base/static Traefik configuration files
- Certificate templates for Traefik container
- Configuration consumed by compose via bind mounts

**`traefik/dynamic/`:**
- Live dynamic routing definitions (routers, middlewares, services)
- Runtime configuration that Traefik watches for changes
- Used for service discovery and route management

**`traefik/acme/`:**
- ACME certificate storage (Let's Encrypt certificates)
- Runtime certificate data persisted in volumes

**Other `config/` subdirectories:**
- Service-specific configuration templates (alertmanager, grafana, mailu, monitoring, nginx, prometheus)
- Consumed by compose services via bind mounts
- Templates only - never commit actual secrets

---

*Last Updated: 2025-12-25*
*Maintain this file as project evolves*
