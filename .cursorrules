# Inlock AI Infrastructure - Cursor AI Rules

## Project Overview

This is the Inlock AI infrastructure repository containing Docker Compose configurations, Traefik reverse proxy setup, deployment scripts, and comprehensive documentation.

## Directory Structure - DO NOT DEVIATE

```
inlock-ai-mvp/
├── compose/              # ALL Docker Compose service definitions (Unified)
│   ├── stack.yml         # Main infrastructure stack
│   └── ...
├── config/               # ALL Service configurations
│   ├── traefik/
│   ├── prometheus/
│   └── ...
├── docs/                 # ALL documentation
│   ├── guides/           # Usage & Deployment Guides (Day 2)
│   ├── security/         # Security Protocols
│   ├── deployment/       # Deployment specifics
│   ├── archive/          # Historical/Obsolete files
│   └── ...
├── scripts/              # ALL automation scripts
│   ├── deployment/       # Manage, Populate, Deploy
│   ├── infrastructure/   # Firewall, OS
│   └── monitoring/       # Tests, Diagnostics
├── infrastructure/       # Ansible configurations
└── .env.example          # Environment variable template
```

## CRITICAL RULES - Never Break These

### ❌ What to Avoid (NEVER DO)

1. **DO NOT create competing directory structures**
   - No `compose/services/` or `compose/config/` (deprecated)
   - Use `compose/` for stacks and `config/` for configurations
   - Use `docs/guides/` for new operational guides

2. **DO NOT duplicate configuration files**
   - One authoritative file per service
   - Use `compose/stack.yml` for core infrastructure
   - Use `compose/tooling.yml` for optional tooling (PostHog/Strapi)

3. **DO NOT ignore Git workflow**
   - No `.env` or secrets in Git
   - Always check `docs/guides/GIT-WORKFLOW.md`

### ✅ Best Practices - Always Follow

1. **File Organization**
<<<<<<< Updated upstream
   - Docker Compose: `compose/services/<service>.yml` (or fragments in `compose/config/`)
   - Main stack: `compose/services/stack.yml` (include-based aggregator)
   - Traefik routers: `traefik/dynamic/routers.yml`
   - Deployment Guides: `docs/deployment/` and `docs/tooling-deployment/`
   - Day-2 Operations: `docs/guides/`
   - Architecture/Design: `docs/architecture/`
   - References/Cheat Sheets: `docs/reference/`
   - Reports/Status: `archive/docs/reports/`
   - Security Docs: `docs/security/`
   - Service Docs: `docs/services/`
   - Documentation Index: `docs/index.md`

2. **Naming Conventions**
   - Services: `<service-name>.yml` (e.g., `tooling.yml`, `n8n.yml`)
   - Scripts: `<action>-<target>.sh` (e.g., `test-service-quick.sh`)
   - Docs: Descriptive names in CAPS with hyphens
   
3. **Docker Persistence**
   - **Custom Images:** For code changes / patches (e.g. custom service images)
   - **Bind Mounts:** For configuration files (e.g. `/overrides/config.inc.php`)
   - **Verify:** Always test `docker compose restart` after changes
=======
   - Docker Compose: `compose/<service>.yml`
   - Configs: `config/<service>/<config_file>`
   - Scripts: `scripts/<category>/<script_name>.sh`
>>>>>>> Stashed changes

2. **Network Standards**
   - **edge**: Public facing (Traefik entrypoints)
   - **mgmt**: Admin/Internal services (Auth0 protected)
   - **internal**: Database/Backend only (No external access)

<<<<<<< Updated upstream
5. **Documentation Updates**
   - Update `docs/index.md` for major changes (entry point)
   - Deployment guides → `docs/deployment/` and `docs/tooling-deployment/`
   - Day-2/Operations guides → `docs/guides/`
   - Architecture/Design docs → `docs/architecture/`
   - References/Cheat sheets → `docs/reference/`
   - Reports/Status → `archive/docs/reports/`
   - Security docs → `docs/security/`
   - Service-specific docs → `docs/services/`
   - Keep root directory clean (only README, QUICK-START, etc.)
=======
3. **Deployment Commands**
   - Use unified scripts:
     - `./scripts/deployment/manage-services.sh ...`
     - `./scripts/deployment/populate-portainer.sh ...`
   - Always run from root: `docker compose -f compose/stack.yml ...`
>>>>>>> Stashed changes

## Environment & Secrets

**Locations:**

- Templates: `.env.example`
- Real Secrets: `secrets-real/` (GitIgnored) or Docker Secrets

**Encryption:**

- Consider Sops/Age for future secret management (see `docs/security/SECURITY-MANUAL.md`)

## Security Guidelines

1. **Network Isolation**
   - Admin services → `mgmt` network
   - Use `traefik` middleware for IP allowlisting (Tailscale CIDRs)

2. **Authentication**
   - Forward Auth (OAuth2-Proxy) is mandatory for admin UIs
   - See `docs/security/SECURITY-MANUAL.md`

3. **Hardening**
   - `no-new-privileges:true` on all containers
   - Read-only root filesystems where feasible

## Code Style

**Docker Compose:**
<<<<<<< Updated upstream
- Use secrets for sensitive data
- Always define networks explicitly
- Include health checks
- Set resource limits
- Use specific image tags (not `latest` in production)

**Shell Scripts:**
- Include shebang: `#!/bin/bash`
- Set error handling: `set -euo pipefail`
- Add help text
- Make executable: `chmod +x`

## Making Changes

### Adding a New Service

1. Create `compose/services/<service>.yml` (or reusable fragment in `compose/config/`)
2. Add to `compose/services/stack.yml` includes (if part of main stack)
3. Validate: `docker compose -f compose/services/stack.yml config`
4. Create deployment guide in `docs/tooling-deployment/` or `docs/deployment/`
5. Add Traefik routers to `traefik/dynamic/routers.yml`
   - For admin services: Use `admin-forward-auth` middleware (Auth0)
   - **DO NOT** add `allowed-admins` IP allowlist middleware after `admin-forward-auth`
   - Correct order: `secure-headers`, `admin-forward-auth`, `mgmt-ratelimit`
6. Update `env.example` with new variables
7. Test deployment
8. Update README.md

### Modifying Existing Service

1. Check current state: `docker compose ps <service>`
2. Edit `compose/services/<service>.yml` (or fragment in `compose/config/`)
3. Validate: `docker compose -f compose/services/stack.yml config` (or individual file)
4. Deploy: `docker compose -f compose/services/stack.yml up -d` (or individual service)
5. Verify: Check logs and health
6. Document changes

### Organizing Files

- **Status reports** → `archive/docs/reports/<topic>/`
- **Audit logs** → `docs/audit/`
- **Deployment guides** → `docs/deployment/` and `docs/tooling-deployment/`
- **Day-2 Operations** → `docs/guides/`
- **Architecture/Design** → `docs/architecture/`
- **References/Cheat sheets** → `docs/reference/`
- **Security docs** → `docs/security/`
- **Service docs** → `docs/services/`
- **Scripts** → `scripts/`
- **Service configs** → `config/<service>/` (templates only)
- **Traefik static config** → `config/traefik/`
- **Traefik dynamic config** → `traefik/dynamic/`
=======
>>>>>>> Stashed changes

- Use relative paths: `../config/...`
- Define `container_name` for easy lookup
- Healthchecks are mandatory for production services

**Shell Scripts:**

- Use `#!/bin/bash`
- `set -e` or `set -euo pipefail` appropriate
- Provide help/usage text

---

*Last Updated: 2025-12-31*
*Reflects Global Consolidation (v2.0)*
