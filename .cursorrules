# Certificate and SSL/TLS Configuration Safeguards

## CRITICAL: Certificate Protection Rules

### ⚠️ Certificate Configuration is CRITICAL
**SSL/TLS certificate misconfiguration can break the entire platform. Always verify certificate settings before making changes.**

### Pre-Task Certificate Checklist

Before starting ANY task that involves:
- Traefik configuration changes
- Subdomain/router modifications
- Docker compose updates
- Network or service changes
- DNS modifications

**MUST verify:**

1. **Positive SSL Certificate Protection**
   - `inlock.ai` and `www.inlock.ai` MUST use Positive SSL certificate (NOT Let's Encrypt)
   - Certificate location: `/home/comzis/apps/secrets-real/positive-ssl.crt` and `.key`
   - Traefik TLS config: `traefik/dynamic/tls.yml` - uses `options: default`
   - Router config: `traefik/dynamic/routers.yml` - inlock-ai router uses `tls.options: default`
   - **NEVER change the TLS configuration for inlock.ai/www.inlock.ai routers**

2. **Certificate Fingerprint Verification**
   - Positive SSL fingerprint: `FB:FD:85:7E:20:F0:E3:9C:79:D4:0D:BC:7B:7F:5A:2C:5F:E9:1D:39:BF:08:41:C4:53:A4:06:D5:E4:D2:2B:E8`
   - Always verify certificates match before and after changes:
     ```bash
     openssl s_client -connect inlock.ai:443 -servername inlock.ai 2>/dev/null | openssl x509 -noout -fingerprint -sha256
     ```

3. **Cloudflare API Token**
   - Required for Let's Encrypt DNS-01 challenge for subdomains
   - Environment variable: `CLOUDFLARE_DNS_API_TOKEN` or `CLOUDFLARE_API_TOKEN`
   - Location: `/home/comzis/inlock/.env`
   - Must have DNS:Edit permissions for `inlock.ai` zone
   - Verify token is valid before making changes:
     ```bash
     curl -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" -H "Authorization: Bearer $TOKEN"
     ```

4. **Traefik Router Configuration Rules**
   - **inlock.ai/www.inlock.ai**: MUST use `tls.options: default` (Positive SSL)
   - **All other subdomains**: Use `tls.certResolver: le-dns` (Let's Encrypt)
   - Never add `certResolver` to inlock.ai/www.inlock.ai routers
   - Never remove `options: default` from inlock.ai/www.inlock.ai routers

5. **Certificate Expiration Monitoring**
   - Positive SSL expires: December 7, 2026
   - Check expiration before major changes:
     ```bash
     openssl s_client -connect inlock.ai:443 -servername inlock.ai 2>/dev/null | openssl x509 -noout -dates
     ```

### When Adding New Subdomains

1. **Check if subdomain should use Positive SSL or Let's Encrypt**
   - If it's `inlock.ai` or `www.inlock.ai` → Use Positive SSL (`tls.options: default`)
   - All other subdomains → Use Let's Encrypt (`tls.certResolver: le-dns`)

2. **Verify Traefik router configuration**
   - Add router to `traefik/dynamic/routers.yml`
   - Add service to `traefik/dynamic/services.yml` if new service
   - Use correct TLS configuration based on domain

3. **Test certificate after changes**
   - Wait 1-2 minutes for certificate provisioning
   - Verify HTTPS connectivity: `curl -I https://subdomain.inlock.ai`
   - Check certificate: `openssl s_client -connect subdomain.inlock.ai:443 -servername subdomain.inlock.ai`

### When Modifying Traefik Configuration

1. **Backup current configuration**
   ```bash
   cp traefik/dynamic/routers.yml traefik/dynamic/routers.yml.backup
   cp traefik/dynamic/tls.yml traefik/dynamic/tls.yml.backup
   ```

2. **Verify Positive SSL configuration is preserved**
   - Check `tls.yml` still has Positive SSL in default store
   - Check `routers.yml` inlock-ai router still uses `tls.options: default`

3. **After changes, verify certificates**
   - Test inlock.ai certificate matches Positive SSL fingerprint
   - Test www.inlock.ai certificate matches Positive SSL fingerprint
   - Test new subdomains have valid certificates

### Certificate-Related Files to Protect

**NEVER modify without verification:**
- `/home/comzis/apps/secrets-real/positive-ssl.crt`
- `/home/comzis/apps/secrets-real/positive-ssl.key`
- `traefik/dynamic/tls.yml` (especially the `default` store configuration)
- `traefik/dynamic/routers.yml` (especially the `inlock-ai` router TLS config)

### Error Detection

**If you see these errors, STOP and verify certificates:**
- `SSL routines::tlsv1 unrecognized name`
- `certificate verify failed`
- `unable to get local issuer certificate`
- `error:0A000458` (SSL handshake failures)
- Cloudflare API errors (9109, 403) when requesting certificates

### Post-Change Verification Script

After ANY certificate-related change, run:
```bash
# Verify Positive SSL is still active
openssl s_client -connect inlock.ai:443 -servername inlock.ai 2>/dev/null | \
  openssl x509 -noout -fingerprint -sha256 | \
  grep -q "FB:FD:85:7E:20:F0:E3:9C:79:D4:0D:BC:7B:7F:5A:2C:5F:E9:1D:39:BF:08:41:C4:53:A4:06:D5:E4:D2:2B:E8" && \
  echo "✅ Positive SSL verified" || echo "❌ CERTIFICATE MISMATCH - IMMEDIATE ACTION REQUIRED"
```

### Emergency Rollback

If certificates break:
1. Restore from backup: `cp traefik/dynamic/routers.yml.backup traefik/dynamic/routers.yml`
2. Restart Traefik: `docker compose -f compose/services/stack.yml restart traefik`
3. Verify certificates are restored
4. Check Traefik logs: `docker compose -f compose/services/stack.yml logs traefik --tail 50`

### Documentation References

- Positive SSL certificate: Sectigo Limited
- Certificate valid until: December 7, 2026
- Zone ID: `8d7c44f4c4a25263d10b87f394bc9076`
- Domain: `inlock.ai`

---

**Remember: Certificate misconfiguration = Platform downtime. Always verify before and after changes.**

---

## Service Configuration Safeguards

### ⚠️ Service Configuration is CRITICAL
**Service misconfiguration can break applications, database connections, and authentication flows. Always verify service settings before making changes.**

### Pre-Task Service Checklist

Before starting ANY task that involves:
- Docker Compose service modifications
- Environment variable changes
- Database configuration updates
- Application URL changes
- Proxy/reverse proxy configuration

**MUST verify:**

1. **Coolify Configuration Protection**
   - `DB_PASSWORD` MUST have default fallback: `${POSTGRES_PASSWORD:-ee7a8e171c075626d63b3cb7292b0cba9e4e71b83c9a3fff}`
   - `APP_URL` MUST be `https://deploy.inlock.ai` (NOT localhost)
   - `TRUSTED_PROXIES=*` MUST be set for Traefik reverse proxy
   - `FORWARDED_HEADERS` MUST include required headers
   - **NEVER remove these configurations**

2. **Grafana Configuration Protection**
   - `GF_SERVER_DOMAIN=grafana.inlock.ai` MUST be hardcoded (NOT `${DOMAIN}`)
   - `GF_SERVER_ROOT_URL=https://grafana.inlock.ai` MUST be hardcoded (NOT `${DOMAIN}`)
   - **NEVER use environment variables that may be empty**

3. **Database Password Synchronization**
   - PostgreSQL container password MUST match application `DB_PASSWORD`
   - Application MUST have default fallback password
   - **NEVER remove default fallback**

### Protected Configuration Files

**NEVER modify without verification:**
- `compose/services/coolify.yml` (especially database and proxy config)
- `compose/services/stack.yml` (especially Grafana domain config)

### Post-Change Verification

After ANY service configuration change, run:
```bash
/home/comzis/.cursor/projects/home-comzis-inlock/rules/service-health-check.sh
```

### Documentation

See `/home/comzis/.cursor/projects/home-comzis-inlock/rules/service-configuration-safeguards.md` for detailed safeguards.

---

**Remember: Service misconfiguration = Application downtime. Always verify before and after changes.**

---

## Docker Compose Environment Variable Safeguards

### ⚠️ CRITICAL: Environment Variable Substitution Issue

**Docker Compose variable substitution `${VAR}` ONLY works if the variable is in the shell environment when docker-compose runs. If not, it becomes an empty string, causing silent failures.**

### The Problem

When docker-compose processes YAML files:
1. **`environment` section with `${VAR}` substitution is processed FIRST**
2. **`env_file` directive loads variables AFTER substitution**
3. **If `${VAR}` is not in shell environment → becomes `""` (empty string)**
4. **Empty string overrides what `env_file` would load**

**Result**: Services start with empty environment variables and fail silently.

### Known Affected Services

**Services that require environment variables from `/home/comzis/inlock/.env`:**
- **Traefik**: `CLOUDFLARE_DNS_API_TOKEN` (for Let's Encrypt DNS-01 challenge)
- **oauth2-proxy**: `AUTH0_ADMIN_CLIENT_ID`, `AUTH0_ADMIN_CLIENT_SECRET`, `OAUTH2_PROXY_COOKIE_SECRET`
- **Other services**: Any service using `${VAR}` substitution in `environment` section

### Pre-Task Checklist

Before running ANY docker-compose command:

1. **ALWAYS source the .env file first:**
   ```bash
   source /home/comzis/inlock/.env
   # OR
   export $(grep -v '^#' /home/comzis/inlock/.env | xargs)
   ```

2. **Verify variables are loaded:**
   ```bash
   echo $CLOUDFLARE_DNS_API_TOKEN
   echo $AUTH0_ADMIN_CLIENT_ID
   ```

3. **Then run docker-compose:**
   ```bash
   cd /home/comzis/projects/inlock-ai-mvp
   docker compose -f compose/services/stack.yml up -d <service>
   ```

### When Modifying Docker Compose Files

**NEVER use variable substitution without fallback or verification:**

❌ **BAD** (will fail if variable not in shell):
```yaml
environment:
  - OAUTH2_PROXY_CLIENT_ID=${AUTH0_ADMIN_CLIENT_ID}
```

✅ **BETTER** (with fallback, but still requires shell env):
```yaml
environment:
  - OAUTH2_PROXY_CLIENT_ID=${AUTH0_ADMIN_CLIENT_ID:-}
```

✅ **BEST** (rely on env_file, document the requirement):
```yaml
env_file:
  - /home/comzis/inlock/.env
environment:
  # env_file loads AUTH0_ADMIN_CLIENT_ID from .env
  # Variable substitution requires shell environment when docker-compose runs
  # Always source .env before running docker-compose commands
  - OAUTH2_PROXY_CLIENT_ID=${AUTH0_ADMIN_CLIENT_ID:-}
```

### Error Detection

**If you see these errors, check environment variables:**

- `missing setting: cookie-secret` (oauth2-proxy)
- `provider missing setting: client-id` (oauth2-proxy)
- `cannot get ACME client cloudflare: some credentials information are missing` (Traefik)
- `The "VAR" variable is not set. Defaulting to a blank string.` (docker-compose warning)
- Service starts but immediately crashes/restarts
- Service returns HTTP 500 errors due to missing configuration

### Post-Change Verification

After ANY docker-compose change or restart:

1. **Check service logs for configuration errors:**
   ```bash
   docker compose -f compose/services/stack.yml logs <service> --tail 50 | grep -i "error\|missing\|invalid"
   ```

2. **Verify environment variables in container:**
   ```bash
   docker compose -f compose/services/stack.yml exec <service> env | grep -E "OAUTH2_PROXY|CLOUDFLARE"
   ```

3. **Test service functionality:**
   ```bash
   curl -I https://service.inlock.ai
   ```

### Prevention Script

**Always use this pattern for docker-compose commands:**
```bash
#!/bin/bash
# Load environment variables
source /home/comzis/inlock/.env

# Run docker-compose
cd /home/comzis/projects/inlock-ai-mvp
docker compose -f compose/services/stack.yml "$@"
```

---

## Antigravity Coordination Rules

### ⚠️ CRITICAL: Cursor vs Antigravity Workflow Separation

**Cursor** (this workspace) handles infrastructure/ops. **Antigravity** handles feature development. They must coordinate to prevent conflicts.

### Tool Responsibilities

| Tool | Purpose | Workspace | Repository | Changes |
|------|---------|-----------|------------|---------|
| **Cursor** | Infrastructure, safeguards, ops | `home-comzis-inlock` | Not a git repo | Docker Compose, Traefik, certificates, services |
| **Antigravity** | Feature development, testing | `inlock-ai-mvp` or `/opt/inlock-ai-secure-mvp` | Git repository | Application code, features, frontend |

### Pre-Task Checklist for Cursor Users

Before making ANY infrastructure changes:

1. **Check if Antigravity is working on related features:**
   - Review recent git commits: `cd /home/comzis/projects/inlock-ai-mvp && git log --oneline -10`
   - Check active branches: `git branch -a`
   - Review PRs if accessible

2. **Coordinate infrastructure changes:**
   - If Antigravity is working on features that depend on infrastructure → coordinate timing
   - If changing service configurations → notify/document changes
   - If modifying Docker Compose → ensure Antigravity's changes won't conflict

3. **Document changes for Antigravity:**
   - Update relevant documentation in `docs/`
   - Add notes about infrastructure changes that affect development
   - Update `.cursorrules` if new safeguards are needed

### Protected Files for Antigravity

**NEVER modify these without coordinating with Antigravity workflow:**

- `/home/comzis/projects/inlock-ai-mvp/compose/inlock-ai.yml` - Application service config
- `/home/comzis/projects/inlock-ai-mvp/compose/inlock-db.yml` - Database config (if Antigravity needs DB changes)
- `/opt/inlock-ai-secure-mvp/` - Frontend source code (Antigravity's domain)

### Antigravity Workflow Rules

**When Antigravity is working on features:**

1. **Infrastructure changes should be minimal:**
   - Avoid major service restarts during active development
   - Coordinate certificate/service changes
   - Test infrastructure changes in isolation first

2. **Document infrastructure dependencies:**
   - If Antigravity needs new environment variables → add to `.env` and document
   - If Antigravity needs new services → coordinate Docker Compose changes
   - If Antigravity needs DNS/subdomain changes → follow certificate safeguards

3. **Verify Antigravity's changes don't break infrastructure:**
   - Review git diffs before merging Antigravity's PRs
   - Test infrastructure after Antigravity's deployments
   - Ensure Antigravity follows infrastructure safeguards

### Antigravity-Specific Safeguards

**When reviewing Antigravity's changes:**

1. **Check for infrastructure impact:**
   - Does it modify Docker Compose files? → Verify against safeguards
   - Does it change environment variables? → Verify against service config rules
   - Does it modify Traefik config? → Verify against certificate rules

2. **Verify Antigravity follows rules:**
   - Certificate rules (Positive SSL for inlock.ai/www.inlock.ai)
   - Service configuration rules (Coolify, Grafana, etc.)
   - Environment variable handling rules

3. **Coordinate deployment:**
   - Antigravity develops features → Cursor handles deployment
   - Antigravity tests on branches → Cursor verifies infrastructure compatibility
   - Antigravity creates PRs → Cursor reviews infrastructure impact

### Documentation References

- **Antigravity workflow**: `docs/cursor-workflow-guide.md`
- **Antigravity connection**: `docs/antigravity-connection-formats.md`
- **Antigravity git workflow**: `docs/antigravity-git-branch-workflow.md`
- **Frontend development**: `docs/antigravity-frontend-development-prompt.md`

---

## General Best Practices

### 1. Always Verify Before Making Changes

**Before ANY infrastructure change:**
- Run preflight checks: `bash scripts/preflight.sh`
- Review relevant safeguards in `rules/`
- Check service status: `docker compose -f compose/services/stack.yml ps`
- Verify certificates: Use certificate health check script

### 2. Always Test After Making Changes

**After ANY infrastructure change:**
- Run postflight checks: `bash scripts/postflight.sh`
- Test affected services: `curl -I https://service.inlock.ai`
- Check service logs: `docker compose -f compose/services/stack.yml logs <service> --tail 50`
- Verify no errors: `docker compose -f compose/services/stack.yml logs | grep -i error`

### 3. Always Backup Before Modifying

**Before modifying critical files:**
```bash
# Backup Traefik config
cp traefik/dynamic/routers.yml traefik/dynamic/routers.yml.backup.$(date +%Y%m%d-%H%M%S)

# Backup Docker Compose
cp compose/services/stack.yml compose/services/stack.yml.backup.$(date +%Y%m%d-%H%M%S)
```

### 4. Always Source Environment Variables

**Before running docker-compose:**
```bash
source /home/comzis/inlock/.env
# OR create a wrapper script that always sources .env
```

### 5. Always Document Changes

**After making changes:**
- Update relevant documentation
- Add comments to configuration files explaining why
- Update `.cursorrules` if new safeguards are needed
- Commit changes with clear messages

### 6. Always Coordinate with Antigravity

**When making infrastructure changes:**
- Check if Antigravity is working on related features
- Document changes that affect development workflow
- Update guides if workflow changes

---

**Remember: Infrastructure changes affect the entire platform. Always verify, test, backup, and coordinate.**
