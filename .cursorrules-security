# Security Rules for Inlock AI Infrastructure

## üîí CRITICAL SECURITY RULES - NEVER VIOLATE

### Firewall & Network Security
- **NEVER** open firewall ports without explicit user approval
- **NEVER** modify SSH configuration without explicit user approval  
- **NEVER** change sudo/root access without explicit user approval
- **NEVER** disable firewall rules without explicit user approval
- Server maintains **10/10 security score** - preserve it at all costs
- Always verify firewall impact before making changes
- Document all firewall changes in security audit logs

### Secrets Management
- **NEVER** commit secrets, passwords, or tokens to Git
- **NEVER** hardcode credentials in code or configuration files
- **NEVER** log secrets or sensitive data
- Always use Docker secrets or environment variables for sensitive data
- Verify `.gitignore` before committing files with sensitive data
- Use `/home/comzis/apps/secrets-real/` for actual secrets (NOT in repo)
- Only commit `.example` placeholder files in `secrets/` directory

### Authentication & Authorization
- All admin services **MUST** use Auth0 + OAuth2-Proxy
- **CRITICAL**: IP allowlist middlewares (`allowed-admins`) must **NEVER** be placed AFTER `admin-forward-auth` middleware
  - IP allowlists block authenticated users if placed after authentication middleware
  - Auth0 authentication provides sufficient security - IP allowlists are redundant after auth
  - If IP restrictions are needed, they should be placed BEFORE authentication (blocks before auth, not after)
- Never bypass authentication for convenience
- Never remove authentication middleware without explicit approval
- Always verify Auth0 configuration before deploying changes
- Test authentication flows after any changes
- When configuring Traefik routers with `admin-forward-auth`, do NOT include `allowed-admins` middleware

### Container Security
- Always drop **ALL** capabilities (`cap_drop: ALL`)
- Always use `no-new-privileges: true`
- Prefer read-only filesystems where possible
- Use non-root users where possible
- Pin images to specific digests in production (not `latest`)
- Never run containers with `privileged: true` without explicit approval
- Always include health checks for services
- Set resource limits (memory, CPU) for all containers

### Network Isolation
- Admin services: **Only** on `mgmt` network
- Public services: **Only** on `edge` network via Traefik
- Internal services: **Only** on `internal` network
- Never expose internal services directly to public networks
- Use Docker socket proxy for container management (never direct socket access)
- Verify network isolation after any service changes

### TLS/SSL Security
- Always use TLS for external services
- Never disable certificate validation
- Use PositiveSSL for apex domain (`inlock.ai`)
- Use Let's Encrypt for subdomains
- Verify certificate validity before deployment
- Never commit certificate files or keys

### Access Control
- Always use IP allowlists for admin services
- Verify Tailscale IPs are current before updating allowlists
- Test access control from unauthorized IPs after changes
- Document all access control changes
- Never remove IP restrictions without replacement

## ‚ö†Ô∏è Before Making Security Changes

1. **Review Impact**: Understand how changes affect security posture
2. **Test First**: Test in non-production environment when possible
3. **Document**: Document changes in security audit logs (`docs/security/`)
4. **Verify**: Verify no regression in security score
5. **Get Approval**: Get explicit user approval for firewall/SSH/sudo changes

## üõ°Ô∏è Security Best Practices

### When Adding New Services
1. Place on appropriate network (`edge`, `mgmt`, or `internal`)
2. Add IP allowlist middleware if admin service
3. Configure Auth0 + OAuth2-Proxy if admin service
4. Add health checks
5. Set resource limits
6. Drop all capabilities
7. Use `no-new-privileges`
8. Document in security audit

### When Modifying Existing Services
1. Review current security configuration
2. Ensure changes don't reduce security posture
3. Test authentication/authorization after changes
4. Verify network isolation maintained
5. Update documentation if security model changes

### When Troubleshooting
1. Never disable security controls as a workaround
2. Never expose services directly to fix connectivity
3. Never commit temporary security bypasses
4. Always restore security controls after troubleshooting
5. Document security implications of any workarounds

## üö® Security Incident Response

If security is compromised:
1. **Immediately** notify user
2. **Do NOT** make changes without approval
3. Document the incident in `docs/security/`
4. Preserve logs and evidence
5. Follow user's instructions for remediation

## üìã Security Checklist

Before committing any changes, verify:
- [ ] No secrets in code or config files
- [ ] `.env` files are in `.gitignore`
- [ ] No hardcoded credentials
- [ ] Firewall rules reviewed (if changed)
- [ ] Network isolation maintained
- [ ] Authentication/authorization intact
- [ ] Container security settings applied
- [ ] Documentation updated if security model changed
- [ ] Security score impact assessed

## üîç Security Validation

After making changes:
1. Run security validation scripts if available
2. Verify firewall status: `sudo ufw status verbose`
3. Check container security: `docker inspect <container> | grep -i security`
4. Test access control from unauthorized IPs
5. Verify authentication flows
6. Check logs for security warnings

---

**Remember**: Security is not optional. When in doubt, ask for explicit approval before making security-related changes.

*Last Updated: 2025-12-25*  
*Maintain this file as security requirements evolve*
