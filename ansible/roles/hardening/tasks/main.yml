---
- name: Check for SSH hardening script
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/harden-ssh.sh"
  register: ssh_script

- name: Execute SSH hardening script
  ansible.builtin.command:
    cmd: "bash {{ scripts_dir }}/harden-ssh.sh"
  when: ssh_script.stat.exists

- name: Check for Docker hardening script
  ansible.builtin.stat:
    path: "{{ scripts_dir }}/harden-docker.sh"
  register: docker_script

- name: Execute Docker hardening script
  ansible.builtin.command:
    cmd: "bash {{ scripts_dir }}/harden-docker.sh"
  when: docker_script.stat.exists

- name: Ensure unattended-upgrades installed
  ansible.builtin.apt:
    name: unattended-upgrades
    state: present

- name: Enable automatic security updates
  ansible.builtin.command:
    cmd: dpkg-reconfigure --priority=low unattended-upgrades
  args:
    creates: /etc/apt/apt.conf.d/20auto-upgrades

- name: Ensure ufw is installed
  ansible.builtin.apt:
    name: ufw
    state: present

- name: Get current UFW status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_status_check
  changed_when: false
  failed_when: false

- name: Reset ufw to defaults
  ansible.builtin.command:
    cmd: ufw --force reset
  when: ufw_status_check.rc != 0 or 'Status: active' not in ufw_status_check.stdout

- name: Set ufw default deny incoming
  ansible.builtin.command:
    cmd: ufw default deny incoming
  changed_when: false

- name: Set ufw default allow outgoing
  ansible.builtin.command:
    cmd: ufw default allow outgoing
  changed_when: false

- name: Set ufw default allow routed
  ansible.builtin.command:
    cmd: ufw default allow routed
  changed_when: false

- name: Allow Tailscale UDP port
  ansible.builtin.command:
    cmd: ufw allow 41641/udp comment 'Tailscale'
  changed_when: false

- name: Allow SSH
  ansible.builtin.command:
    cmd: ufw allow 22/tcp comment 'SSH'
  changed_when: false

- name: Allow HTTP for Traefik
  ansible.builtin.command:
    cmd: ufw allow 80/tcp comment 'HTTP'
  changed_when: false

- name: Allow HTTPS for Traefik
  ansible.builtin.command:
    cmd: ufw allow 443/tcp comment 'HTTPS'
  changed_when: false

- name: Enable ufw
  ansible.builtin.command:
    cmd: ufw --force enable
  changed_when: "'Status: active' not in ufw_status_check.stdout"

- name: Check firewall status
  ansible.builtin.command:
    cmd: ufw status verbose
  register: ufw_status
  changed_when: false

- name: Display firewall status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
