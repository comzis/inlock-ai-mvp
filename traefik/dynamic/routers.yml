http:
  routers:
    dashboard-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && Path(`/`)
      middlewares:
        - dashboard-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    api-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (Path(`/api`) || Path(`/api/`))
      middlewares:
        - api-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    dashboard:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (PathPrefix(`/dashboard`) || (PathPrefix(`/api/`) && !Path(`/api`) && !Path(`/api/`)))
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: api@internal
      priority: 100
      tls:
        certResolver: le-dns
    
    # Homepage service - COMMENTED OUT - Replaced by Inlock AI app
    # homepage:
    #   entryPoints:
    #     - websecure
    #   rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
    #   middlewares:
    #     - secure-headers
    #   service: homepage
    #   tls:
    #     certResolver: le-tls
    
    portainer:
      entryPoints:
        - websecure
      rule: Host(`portainer.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
        - allowed-admins
        - mgmt-ratelimit
      service: portainer
      tls:
        certResolver: le-dns
    
    n8n:
      entryPoints:
        - websecure
      rule: Host(`n8n.inlock.ai`)
      middlewares:
        - n8n-headers
        - admin-forward-auth
        - allowed-admins
        # mgmt-ratelimit removed - was causing 429 errors on asset loading
      service: n8n
      tls:
        certResolver: le-dns
    
    
    grafana:
      entryPoints:
        - websecure
      rule: Host(`grafana.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-ip-allowlist
        - admin-forward-auth
        - allowed-admins
        - mgmt-ratelimit
      service: grafana
      tls:
        certResolver: le-dns
    
    coolify:
      entryPoints:
        - websecure
      rule: Host(`deploy.inlock.ai`)
      middlewares:
        - coolify-headers
        - admin-ip-allowlist
        - admin-forward-auth
        - allowed-admins
        - mgmt-ratelimit
      service: coolify
      tls:
        certResolver: le-dns
    coolify-login-redirect:
      entryPoints:
        - websecure
      rule: Host(`deploy.inlock.ai`) && Path(`/login`)
      middlewares:
        - coolify-headers
        - coolify-login-to-root
      service: noop@internal
      priority: 200
      tls:
        certResolver: le-dns
    
    homarr:
      entryPoints:
        - websecure
      rule: Host(`dashboard.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-ip-allowlist
        - admin-forward-auth
        - allowed-admins
      service: homarr
      tls:
        certResolver: le-dns

    cockpit:
      entryPoints:
        - websecure
      rule: Host(`cockpit.inlock.ai`)
      middlewares:
        - cockpit-headers
        - admin-forward-auth
        - allowed-admins
        - mgmt-ratelimit
      service: cockpit
      tls:
        certResolver: le-dns

    oauth2-proxy:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && PathPrefix(`/oauth2/`)
      middlewares:
        - secure-headers
        - mgmt-ratelimit
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-ping:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/ping`)
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-root:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/`)
      middlewares:
        - secure-headers
        - oauth2-to-deploy-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    
    # Inlock AI application - Main production route
    # NOTE: Router is now defined via container labels in compose/inlock-ai.yml
    # This ensures the domain stays in sync with the service definition
    # The router below is kept as backup but may be overridden by labels
    # 
    # Routes inlock.ai and www.inlock.ai to the Inlock AI app using Positive SSL
    inlock-ai:
      entryPoints:
        - websecure
      rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        options: default  # Uses Positive SSL certificate
      priority: 50  # Lower priority allows labels to override if needed

    # Mailu Admin UI - Requires OAuth2 authentication
    mailu-admin:
      entryPoints:
        - websecure
      rule: Host(`mail.inlock.ai`) && PathPrefix(`/admin`)
      middlewares:
        - secure-headers
        # - admin-ip-allowlist  # Disabled to allow public admin access
        - admin-forward-auth  # Secured by Auth0
        # - allowed-admins      # Disabled - Mailu has its own auth
        - mgmt-ratelimit
      service: mailu-front
      tls:
        certResolver: le-tls

    # Mailu Webmail - Public access with rate limiting (users authenticate via Mailu)
    mailu-webmail:
      entryPoints:
        - websecure
      rule: Host(`mail.inlock.ai`) && !PathPrefix(`/admin`)
      middlewares:
        - secure-headers
        - proto-header
        - mgmt-ratelimit
      service: mailu-front
      tls:
        certResolver: le-tls
