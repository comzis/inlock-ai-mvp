http:
  routers:
    dashboard-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && Path(`/`)
      middlewares:
        - dashboard-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    api-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (Path(`/api`) || Path(`/api/`))
      middlewares:
        - api-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    dashboard:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (PathPrefix(`/dashboard`) || (PathPrefix(`/api/`) && !Path(`/api`) && !Path(`/api/`)))
      middlewares:
        - secure-headers
        - allowed-admins
        - admin-forward-auth
        - mgmt-ratelimit
      service: api@internal
      priority: 100
      tls:
        certResolver: le-dns
    
    # Homepage service - COMMENTED OUT - Replaced by Inlock AI app
    # homepage:
    #   entryPoints:
    #     - websecure
    #   rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
    #   middlewares:
    #     - secure-headers
    #   service: homepage
    #   tls:
    #     certResolver: le-tls
    
    portainer:
      entryPoints:
        - websecure
      rule: Host(`portainer.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: portainer
      tls:
        certResolver: le-dns
    
    n8n:
      entryPoints:
        - websecure
      rule: Host(`n8n.inlock.ai`)
      middlewares:
        - n8n-headers
        - admin-forward-auth
        # mgmt-ratelimit removed - was causing 429 errors on asset loading
      service: n8n
      tls:
        certResolver: le-dns
    
    
    grafana:
      entryPoints:
        - websecure
      rule: Host(`grafana.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: grafana
      tls:
        certResolver: le-dns
    
    coolify:
      entryPoints:
        - websecure
      rule: Host(`deploy.inlock.ai`)
      middlewares:
        - coolify-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: coolify
      tls:
        certResolver: le-dns
    # coolify-login-redirect removed - was causing redirect loop
    # Coolify handles its own redirects, and this middleware was interfering
    # with the authentication flow
    
    homarr:
      entryPoints:
        - websecure
      rule: Host(`dashboard.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
      service: homarr
      tls:
        certResolver: le-dns

    cockpit:
      entryPoints:
        - websecure
      rule: Host(`cockpit.inlock.ai`)
      middlewares:
        - cockpit-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: cockpit
      tls:
        certResolver: le-dns

    oauth2-proxy:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && PathPrefix(`/oauth2/`)
      middlewares:
        - secure-headers
        - mgmt-ratelimit
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-ping:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/ping`)
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-root:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/`)
      middlewares:
        - secure-headers
        - oauth2-to-deploy-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    
    # Inlock AI application - Main production route
    # NOTE: Router is now defined via container labels in compose/inlock-ai.yml
    # This ensures the domain stays in sync with the service definition
    # The router below is kept as backup but may be overridden by labels
    # 
    # Routes inlock.ai and www.inlock.ai to the Inlock AI app using Positive SSL
    inlock-ai:
      entryPoints:
        - websecure
      rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        options: default  # Uses Positive SSL certificate
      priority: 50  # Lower priority allows labels to override if needed

    # Mailcow UI (web + admin)
    mailcow-http:
      entryPoints:
        - web
      rule: Host(`mail.inlock.ai`)
      service: mailcow
      middlewares:
        - secure-headers
      # HTTP is only used for ACME/health; Traefik handles TLS on websecure

    mailcow:
      entryPoints:
        - websecure
      rule: Host(`mail.inlock.ai`)
      middlewares:
        - secure-headers
      service: mailcow
      tls:
        certResolver: le-tls
