http:
  routers:
    dashboard-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && Path(`/`)
      middlewares:
        - dashboard-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    api-root:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (Path(`/api`) || Path(`/api/`))
      middlewares:
        - api-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    dashboard:
      entryPoints:
        - websecure
      rule: Host(`traefik.inlock.ai`) && (PathPrefix(`/dashboard`) || (PathPrefix(`/api/`) && !Path(`/api`) && !Path(`/api/`)))
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: api@internal
      priority: 100
      tls:
        certResolver: le-dns
    
    # Homepage service - COMMENTED OUT - Replaced by Inlock AI app
    # homepage:
    #   entryPoints:
    #     - websecure
    #   rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
    #   middlewares:
    #     - secure-headers
    #   service: homepage
    #   tls:
    #     certResolver: le-tls
    
    portainer:
      entryPoints:
        - websecure
      rule: Host(`portainer.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: portainer
      tls:
        certResolver: le-dns
    
    # n8n: n8n-headers (Host), n8n-ratelimit (not mgmt-ratelimit) — see docs/services/n8n/N8N-TRAEFIK-PROXY-REQUIREMENTS.md
    n8n:
      entryPoints:
        - websecure
      rule: Host(`n8n.inlock.ai`)
      middlewares:
        - n8n-headers
        - admin-forward-auth
        - n8n-ratelimit
      service: n8n
      tls:
        certResolver: le-dns
    
    
    grafana:
      entryPoints:
        - websecure
      rule: Host(`grafana.inlock.ai`)
      middlewares:
        - secure-headers
        - admin-forward-auth
        - mgmt-ratelimit
      service: grafana
      tls:
        certResolver: le-dns
    
    # coolify: REMOVED (2026-02-10) — deploy.inlock.ai no longer served
    # homarr: REMOVED (2026-02-10) — dashboard.inlock.ai no longer served

    cockpit:
      entryPoints:
        - websecure
      rule: Host(`cockpit.inlock.ai`)
      middlewares:
        - cockpit-headers
        - allowed-admins
        - admin-forward-auth
        - mgmt-ratelimit
      service: cockpit
      tls:
        certResolver: le-dns

    oauth2-proxy:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && PathPrefix(`/oauth2/`)
      middlewares:
        - secure-headers
        - mgmt-ratelimit
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-ping:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/ping`)
      service: oauth2-proxy
      tls:
        certResolver: le-dns
    oauth2-proxy-root:
      entryPoints:
        - websecure
      rule: Host(`auth.inlock.ai`) && Path(`/`)
      middlewares:
        - secure-headers
        - oauth2-to-deploy-redirect
      service: noop@internal
      tls:
        certResolver: le-dns
    
    # Inlock AI application - Main production route
    # NOTE: Router is now defined via container labels in compose/inlock-ai.yml
    # This ensures the domain stays in sync with the service definition
    # The router below is kept as backup but may be overridden by labels
    # 
    # Routes inlock.ai and www.inlock.ai to the Inlock AI app using Positive SSL
    inlock-ai:
      entryPoints:
        - websecure
      rule: Host(`inlock.ai`) || Host(`www.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        options: default  # Uses Positive SSL certificate
      priority: 50  # Lower priority allows labels to override if needed

    # Mailcow UI (web + admin)
    mailcow-http:
      entryPoints:
        - web
      rule: Host(`mail.inlock.ai`)
      service: mailcow
      middlewares:
        - secure-headers
      # HTTP is only used for ACME/health; Traefik handles TLS on websecure

    # Mailcow autodiscover/autoconfig/mta-sts (ACME HTTP-01 + HTTPS)
    mailcow-autodiscover-http:
      entryPoints:
        - web
      rule: Host(`autodiscover.inlock.ai`) || Host(`autoconfig.inlock.ai`) || Host(`mta-sts.inlock.ai`)
      service: mailcow
      middlewares:
        - secure-headers

    mailcow-autodiscover:
      entryPoints:
        - websecure
      rule: Host(`autodiscover.inlock.ai`) || Host(`autoconfig.inlock.ai`) || Host(`mta-sts.inlock.ai`)
      service: mailcow
      middlewares:
        - secure-headers
      tls:
        certResolver: le-dns

    # Mailcow /admin path: restrict to Tailscale IPs only (higher priority than catch-all mailcow)
    mailcow-admin-path:
      entryPoints:
        - websecure
      rule: Host(`mail.inlock.ai`) && PathPrefix(`/admin`)
      middlewares:
        - secure-headers
        - proto-header
        - mailcow-admin-allowlist
      service: mailcow
      priority: 200
      tls:
        certResolver: le-dns

    mailcow:
      entryPoints:
        - websecure
      rule: Host(`mail.inlock.ai`)
      middlewares:
        - secure-headers
        - proto-header
      service: mailcow
      tls:
        certResolver: le-dns

    # Mailcow aliases - redirect to main mail subdomain
    mailcow-alias:
      entryPoints:
        - websecure
      rule: Host(`mailcow.inlock.ai`)
      middlewares:
        - secure-headers
      service: mailcow
      tls:
        certResolver: le-dns

    # Mailcow webmail alias
    webmail:
      entryPoints:
        - websecure
      rule: Host(`webmail.inlock.ai`)
      middlewares:
        - secure-headers
        - proto-header
      service: mailcow
      tls:
        certResolver: le-dns

    # Mailcow admin alias (admin.inlock.ai) - same IP restriction as /admin
    mailcow-admin:
      entryPoints:
        - websecure
      rule: Host(`admin.inlock.ai`)
      middlewares:
        - secure-headers
        - proto-header
        - mailcow-admin-allowlist
      service: mailcow
      tls:
        certResolver: le-dns

    # Auth0 alias - redirect to auth subdomain
    auth0-alias:
      entryPoints:
        - websecure
      rule: Host(`auth0.inlock.ai`)
      middlewares:
        - secure-headers
        - oauth2-to-deploy-redirect
      service: oauth2-proxy
      tls:
        certResolver: le-dns

    # API subdomain - route to Inlock AI API
    api:
      entryPoints:
        - websecure
      rule: Host(`api.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        certResolver: le-dns

    # App subdomain - alias for main app
    app:
      entryPoints:
        - websecure
      rule: Host(`app.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        certResolver: le-dns

    # Portal subdomain - route to main app
    portal:
      entryPoints:
        - websecure
      rule: Host(`portal.inlock.ai`)
      middlewares:
        - secure-headers
      service: inlock-ai
      tls:
        certResolver: le-dns
