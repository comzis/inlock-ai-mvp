http:
  middlewares:
    secure-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: true
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: true
        permissionsPolicy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    # OAuth2-Proxy forward auth for admin services
    # Routes unauthenticated users to Auth0 login
    # All admin services (Traefik, Portainer, Grafana, n8n, Coolify, Homarr) use this
    # 
    # IMPORTANT: Use the INTERNAL service URL (http://oauth2-proxy:4180/oauth2/auth)
    # Using the public URL (https://auth.inlock.ai/oauth2/auth) causes the request
    # to loop back through Traefik and get blocked by the IP allowlist middleware
    # before oauth2-proxy ever sees it.
    # 
    # NOTE: forwardAuth returns 401 for unauthenticated requests. The error handler
    # middleware may not catch forwardAuth responses. If browsers still see 401/403,
    # we may need to use a redirect middleware instead.
    admin-forward-auth:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth
        trustForwardHeader: true
        authResponseHeaders:
          - X-Auth-Request-Email
          - X-Auth-Request-User
          - X-Auth-Request-Groups
          - X-Auth-Request-Access-Token
    # Legacy basic auth - DEPRECATED, use admin-forward-auth instead
    # dashboard-auth:
    #   basicAuth:
    #     usersFile: /run/secrets/traefik-basicauth
    # Legacy portainer auth - DEPRECATED, use admin-forward-auth instead
    # portainer-auth:
    #   forwardAuth:
    #     address: https://auth.inlock.ai/check
    #     trustForwardHeader: true
    #     tls:
    #       insecureSkipVerify: false
    mgmt-ratelimit:
      rateLimit:
        average: 50
        burst: 100
    # IP allowlist for admin services (Traefik dashboard, Portainer, n8n, etc.)
    # 
    # SECURITY NOTE: This only works if Cloudflare proxy is OFF (gray cloud)
    # If Cloudflare proxy is ON, Traefik sees Cloudflare IPs, not real client IPs
    # 
    # For production with Cloudflare proxy ON:
    # - Use Cloudflare WAF rules for IP filtering instead
    # - Or keep admin subdomains with proxy OFF (gray cloud)
    # 
    # ipStrategy is not used here because it's incompatible with direct IP checking
    # When using Cloudflare proxy, configure IP filtering in Cloudflare dashboard
    allowed-admins:
      ipAllowList:
        sourceRange:
          - "100.83.222.69/32"  # Device 1 - Tailscale IP (Server)
          - "100.96.110.8/32"   # Device 2 - Tailscale IP (MacBook)
          # REMOVED: Server's own public IP - containers should use Tailscale for admin access
          # Keeping it allows container breakouts to access admin services without VPN
          - "2a09:bac3:1e53:2664::3d3:2f/128"  # MacBook public IPv6
          - "31.10.147.220/32"  # MacBook public IPv4
          - "172.71.147.142/32"  # MacBook public IPv4 (alternate)
          - "172.71.146.180/32"  # MacBook public IPv4 (alternate)
    dashboard-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/$"
        replacement: "https://traefik.inlock.ai/dashboard/"
        permanent: true
    api-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/api/?$"
        replacement: "https://traefik.inlock.ai/api/overview"
        permanent: false
    # Redirect to oauth2-proxy start (for unauthenticated users)
    redirect-to-oauth:
      redirectRegex:
        regex: "^https://grafana.inlock.ai(/.*)?$"
        replacement: "https://auth.inlock.ai/oauth2/start?rd=https://grafana.inlock.ai${1}"
        permanent: false
    # Error handler to redirect 401/403 to oauth2-proxy sign-in
    # Note: Error handler middleware only catches backend service errors, not forwardAuth responses
    # This may not work for forwardAuth 401 responses - keeping as fallback
    oauth-error-handler:
      errors:
        status:
          - "401-403"
        service: oauth2-proxy@file
        query: "/oauth2/start"


