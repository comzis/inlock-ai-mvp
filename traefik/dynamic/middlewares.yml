http:
  middlewares:
    secure-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: true
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: true
        permissionsPolicy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    n8n-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: false
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: false
        customFrameOptionsValue: "SAMEORIGIN"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        # Don't override Content-Type - let n8n set it correctly
        # ES modules work with both text/javascript and application/javascript
    cockpit-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: true
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: false
        customFrameOptionsValue: "SAMEORIGIN"
    coolify-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: false
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: false
        customFrameOptionsValue: "SAMEORIGIN"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        # Don't override Content-Type - let Coolify set it correctly
        # Coolify uses modern JavaScript that may need different content types
    dashboard-auth:
      basicAuth:
        usersFile: /run/secrets/traefik-basicauth
    admin-forward-auth:
      forwardAuth:
        address: http://oauth2-proxy:4180/oauth2/auth_or_start
        trustForwardHeader: true
        authResponseHeaders:
          - X-Auth-Request-User
          - X-Auth-Request-Email
          - X-Auth-Request-Groups
          - X-Auth-Request-Access-Token
          - X-Auth-Request-Redirect
          - Authorization
        authRequestHeaders:
          - X-Forwarded-Method
          - X-Forwarded-Proto
          - X-Forwarded-Host
          - X-Forwarded-Uri
          - X-Forwarded-For
          - X-Real-Ip
          - Cookie
        tls:
          insecureSkipVerify: false
    mgmt-ratelimit:
      rateLimit:
        average: 50
        burst: 100
    # IP allowlist for admin services (Traefik dashboard, Portainer, n8n, etc.)
    # 
    # SECURITY NOTE: This only works if Cloudflare proxy is OFF (gray cloud)
    # If Cloudflare proxy is ON, Traefik sees Cloudflare IPs, not real client IPs
    # 
    # For production with Cloudflare proxy ON:
    # - Use Cloudflare WAF rules for IP filtering instead
    # - Or keep admin subdomains with proxy OFF (gray cloud)
    # 
    # ipStrategy is not used here because it's incompatible with direct IP checking
    # When using Cloudflare proxy, configure IP filtering in Cloudflare dashboard
    allowed-admins:
      ipAllowList:
        sourceRange:
          - "100.83.222.69/32"  # Device 1 - Tailscale IP (Server)
          - "100.96.110.8/32"   # Device 2 - Tailscale IP (MacBook)
          - "156.67.29.52/32"   # Server public IP (for Cockpit access)
          - "2a09:bac3:1e53:2664::3d3:2f/128"  # MacBook public IPv6
          - "31.10.147.220/32"  # MacBook public IPv4
          - "172.71.147.142/32"  # MacBook public IPv4 (alternate)
          - "172.71.146.180/32"  # MacBook public IPv4 (alternate)
          - "172.18.0.0/16"      # Docker mgmt network (for Traefik forwardAuth)
          - "172.20.0.0/16"      # Docker edge network (for Traefik forwardAuth)
    dashboard-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/$"
        replacement: "https://traefik.inlock.ai/dashboard/"
        permanent: true
    api-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/api/?$"
        replacement: "https://traefik.inlock.ai/api/overview"
        permanent: false
    auth-root-redirect:
      redirectRegex:
        regex: "^https://auth.inlock.ai/?$"
        replacement: "https://auth.inlock.ai/oauth2/start"
        permanent: false
      # Only apply to root path, not to /oauth2/* paths
    oauth2-redirect-fix:
      redirectRegex:
        regex: "^https://auth.inlock.ai/?$"
        replacement: "https://deploy.inlock.ai/"
        permanent: false
    oauth2-root-redirect:
      redirectRegex:
        regex: "^https://auth.inlock.ai/?$"
        replacement: "https://deploy.inlock.ai/"
        permanent: false
    oauth2-to-deploy-redirect:
      redirectRegex:
        regex: ".*"
        replacement: "https://deploy.inlock.ai/"
        permanent: false
    coolify-login-to-root:
      redirectRegex:
        regex: "^https://deploy.inlock.ai/login"
        replacement: "https://deploy.inlock.ai/"
        permanent: true
