http:
  middlewares:
    secure-headers:
      headers:
        sslRedirect: true
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: true
        referrerPolicy: no-referrer-when-downgrade
        frameDeny: true
        permissionsPolicy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    dashboard-auth:
      basicAuth:
        usersFile: /run/secrets/traefik-basicauth
    portainer-auth:
      forwardAuth:
        address: https://auth.inlock.ai/check
        trustForwardHeader: true
        tls:
          insecureSkipVerify: false
    mgmt-ratelimit:
      rateLimit:
        average: 50
        burst: 100
    # IP allowlist for admin services (Traefik dashboard, Portainer, n8n, etc.)
    # 
    # SECURITY NOTE: This only works if Cloudflare proxy is OFF (gray cloud)
    # If Cloudflare proxy is ON, Traefik sees Cloudflare IPs, not real client IPs
    # 
    # For production with Cloudflare proxy ON:
    # - Use Cloudflare WAF rules for IP filtering instead
    # - Or keep admin subdomains with proxy OFF (gray cloud)
    # 
    # ipStrategy is not used here because it's incompatible with direct IP checking
    # When using Cloudflare proxy, configure IP filtering in Cloudflare dashboard
    allowed-admins:
      ipAllowList:
        sourceRange:
          - "100.83.222.69/32"  # Device 1 - Tailscale IP (Server)
          - "100.96.110.8/32"   # Device 2 - Tailscale IP (MacBook)
          # REMOVED: Server's own public IP - containers should use Tailscale for admin access
          # Keeping it allows container breakouts to access admin services without VPN
          - "2a09:bac3:1e53:2664::3d3:2f/128"  # MacBook public IPv6
          - "31.10.147.220/32"  # MacBook public IPv4
          - "172.71.147.142/32"  # MacBook public IPv4 (alternate)
          - "172.71.146.180/32"  # MacBook public IPv4 (alternate)
    dashboard-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/$"
        replacement: "https://traefik.inlock.ai/dashboard/"
        permanent: true
    api-redirect:
      redirectRegex:
        regex: "^https://traefik.inlock.ai/api/?$"
        replacement: "https://traefik.inlock.ai/api/overview"
        permanent: false


