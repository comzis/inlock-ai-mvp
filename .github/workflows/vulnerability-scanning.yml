name: Vulnerability Scanning

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  scan-images:
    name: Scan Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          trivy_version: 'latest'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract images from compose files
        id: extract-images
        run: |
          IMAGES=$(grep -r "image:" compose/services/*.yml | \
            grep -v "#" | \
            awk '{print $2}' | \
            sed 's/"//g' | \
            sed 's/${.*}//g' | \
            grep -v "^$" | \
            sort -u)
          
          echo "images<<EOF" >> $GITHUB_OUTPUT
          echo "$IMAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          IMAGE_COUNT=$(echo "$IMAGES" | wc -l | tr -d ' ')
          echo "count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $IMAGE_COUNT unique image(s) to scan"
      
      - name: Scan images
        id: scan
        continue-on-error: true
        run: |
          mkdir -p reports/vulnerabilities
          
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          SCAN_FAILED=false
          
          echo "${{ steps.extract-images.outputs.images }}" | while IFS= read -r IMAGE; do
            if [ -z "$IMAGE" ]; then
              continue
            fi
            
            echo "Scanning: $IMAGE"
            
            # Scan image
            trivy image \
              --severity HIGH,CRITICAL \
              --format json \
              --output "reports/vulnerabilities/${IMAGE//\//-}.json" \
              "$IMAGE" || SCAN_FAILED=true
            
            # Count vulnerabilities
            if [ -f "reports/vulnerabilities/${IMAGE//\//-}.json" ]; then
              CRIT=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "reports/vulnerabilities/${IMAGE//\//-}.json" 2>/dev/null || echo "0")
              HIGH=$(jq -r '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "reports/vulnerabilities/${IMAGE//\//-}.json" 2>/dev/null || echo "0")
              
              CRITICAL_COUNT=$((CRITICAL_COUNT + CRIT))
              HIGH_COUNT=$((HIGH_COUNT + HIGH))
            fi
          done
          
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "failed=$SCAN_FAILED" >> $GITHUB_OUTPUT
      
      - name: Generate summary report
        if: always()
        run: |
          echo "## Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images scanned:** ${{ steps.extract-images.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Critical vulnerabilities:** ${{ steps.scan.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "**High vulnerabilities:** ${{ steps.scan.outputs.high }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.scan.outputs.critical }}" != "0" ] || [ "${{ steps.scan.outputs.high }}" != "0" ]; then
            echo "⚠️ **Action Required:** Vulnerabilities found. Please review reports." >> $GITHUB_STEP_SUMMARY
          else
            echo "✓ No critical or high severity vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: reports/vulnerabilities/
          retention-days: 30
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && (steps.scan.outputs.critical != '0' || steps.scan.outputs.high != '0')
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.scan.outputs.critical }}';
            const high = '${{ steps.scan.outputs.high }}';
            
            const body = `## ⚠️ Vulnerability Scan Results
            
            **Critical vulnerabilities:** ${critical}
            **High vulnerabilities:** ${high}
            
            Please review the vulnerability reports in the workflow artifacts and address critical issues before merging.
            
            See [Vulnerability Scanning Documentation](docs/security/VULNERABILITY-SCANNING.md) for remediation procedures.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Fail on critical vulnerabilities
        if: steps.scan.outputs.critical != '0'
        run: |
          echo "❌ FAILED: Critical vulnerabilities found"
          echo "Review reports in artifacts and fix before merging"
          exit 1




